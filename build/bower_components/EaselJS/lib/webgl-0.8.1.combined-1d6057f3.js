/*!
* EaselJS
* Visit http://createjs.com/ for documentation, updates and examples.
*
* Copyright (c) 2010 gskinner.com, inc.
*
* Permission is hereby granted, free of charge, to any person
* obtaining a copy of this software and associated documentation
* files (the "Software"), to deal in the Software without
* restriction, including without limitation the rights to use,
* copy, modify, merge, publish, distribute, sublicense, and/or sell
* copies of the Software, and to permit persons to whom the
* Software is furnished to do so, subject to the following
* conditions:
*
* The above copyright notice and this permission notice shall be
* included in all copies or substantial portions of the Software.
*
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
* EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
* OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
* NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
* HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
* WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
* FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
* OTHER DEALINGS IN THE SOFTWARE.
*/
this.createjs=this.createjs||{},function(){"use strict";function t(t){this.Container_constructor(),this.spriteSheet=t}var e=createjs.extend(t,createjs.Container);e.addChild=function(t){return null==t?t:arguments.length>1?this.addChildAt.apply(this,Array.prototype.slice.call(arguments).concat([this.children.length])):this.addChildAt(t,this.children.length)},e.addChildAt=function(t,e){var r=arguments.length,i=arguments[r-1];if(0>i||i>this.children.length)return arguments[r-2];if(r>2){for(var a=0;r-1>a;a++)this.addChildAt(arguments[a],i+a);return arguments[r-2]}if(!(t._spritestage_compatibility>=1))return console&&console.log("Error: You can only add children of type SpriteContainer, Sprite, BitmapText, or DOMElement ["+t.toString()+"]"),t;if(t._spritestage_compatibility<=4){var s=t.spriteSheet;if(!s||!s._images||s._images.length>1||this.spriteSheet&&this.spriteSheet!==s)return console&&console.log("Error: A child's spriteSheet must be equal to its parent spriteSheet and only use one image. ["+t.toString()+"]"),t;this.spriteSheet=s}return t.parent&&t.parent.removeChild(t),t.parent=this,this.children.splice(e,0,t),t},e.toString=function(){return"[SpriteContainer (name="+this.name+")]"},createjs.SpriteContainer=createjs.promote(t,"Container")}(),this.createjs=this.createjs||{},function(){"use strict";function t(t,e,r){this.Stage_constructor(t),this._preserveDrawingBuffer=e||!1,this._antialias=r||!1,this._viewportWidth=0,this._viewportHeight=0,this._projectionMatrix=null,this._webGLContext=null,this._webGLErrorDetected=!1,this._clearColor=null,this._maxTexturesPerDraw=1,this._maxBoxesPointsPerDraw=null,this._maxBoxesPerDraw=null,this._maxIndicesPerDraw=null,this._shaderProgram=null,this._vertices=null,this._verticesBuffer=null,this._indices=null,this._indicesBuffer=null,this._currentBoxIndex=-1,this._drawTexture=null,this._initializeWebGL()}[createjs.SpriteContainer,createjs.Sprite,createjs.BitmapText,createjs.Bitmap,createjs.DOMElement].forEach(function(t,e){t.prototype._spritestage_compatibility=e+1});var e=createjs.extend(t,createjs.Stage);t.NUM_VERTEX_PROPERTIES=5,t.POINTS_PER_BOX=4,t.NUM_VERTEX_PROPERTIES_PER_BOX=t.POINTS_PER_BOX*t.NUM_VERTEX_PROPERTIES,t.INDICES_PER_BOX=6,t.MAX_INDEX_SIZE=Math.pow(2,16),t.MAX_BOXES_POINTS_INCREMENT=t.MAX_INDEX_SIZE/4,e._get_isWebGL=function(){return!!this._webGLContext};try{Object.defineProperties(e,{isWebGL:{get:e._get_isWebGL}})}catch(r){}e.addChild=function(t){return null==t?t:arguments.length>1?this.addChildAt.apply(this,Array.prototype.slice.call(arguments).concat([this.children.length])):this.addChildAt(t,this.children.length)},e.addChildAt=function(t,e){var r=arguments.length,i=arguments[r-1];if(0>i||i>this.children.length)return arguments[r-2];if(r>2){for(var a=0;r-1>a;a++)this.addChildAt(arguments[a],i+a);return arguments[r-2]}return t._spritestage_compatibility>=1?!t.image&&!t.spriteSheet&&t._spritestage_compatibility<=4?(console&&console.log("Error: You can only add children that have an image or spriteSheet defined on them. ["+t.toString()+"]"),t):(t.parent&&t.parent.removeChild(t),t.parent=this,this.children.splice(e,0,t),t):(console&&console.log("Error: You can only add children of type SpriteContainer, Sprite, Bitmap, BitmapText, or DOMElement. ["+t.toString()+"]"),t)},e.update=function(t){if(this.canvas){this.tickOnUpdate&&this.tick(t),this.dispatchEvent("drawstart"),this.autoClear&&this.clear();var e=this._setWebGLContext();e?this.draw(e,!1):(e=this.canvas.getContext("2d"),e.save(),this.updateContext(e),this.draw(e,!1),e.restore()),this.dispatchEvent("drawend")}},e.clear=function(){if(this.canvas){var t=this._setWebGLContext();t?t.clear(t.COLOR_BUFFER_BIT):(t=this.canvas.getContext("2d"),t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,this.canvas.width+1,this.canvas.height+1))}},e.draw=function(t,e){return"undefined"!=typeof WebGLRenderingContext&&(t===this._webGLContext||t instanceof WebGLRenderingContext)?(this._drawWebGLKids(this.children,t),!0):this.Stage_draw(t,e)},e.updateViewport=function(t,e){this._viewportWidth=t,this._viewportHeight=e,this._webGLContext&&(this._webGLContext.viewport(0,0,this._viewportWidth,this._viewportHeight),this._projectionMatrix||(this._projectionMatrix=new Float32Array([0,0,0,0,0,1,-1,1,1])),this._projectionMatrix[0]=2/t,this._projectionMatrix[4]=-2/e)},e.clearImageTexture=function(t){t.__easeljs_texture=null},e.toString=function(){return"[SpriteStage (name="+this.name+")]"},e._initializeWebGL=function(){this._clearColor={r:0,g:0,b:0,a:0},this._setWebGLContext()},e._setWebGLContext=function(){return this.canvas?this._webGLContext&&this._webGLContext.canvas===this.canvas||this._initializeWebGLContext():this._webGLContext=null,this._webGLContext},e._initializeWebGLContext=function(){var t={depth:!1,alpha:!0,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias,premultipliedAlpha:!0},e=this._webGLContext=this.canvas.getContext("webgl",t)||this.canvas.getContext("experimental-webgl",t);if(e){if(this._maxTexturesPerDraw=1,this._setClearColor(this._clearColor.r,this._clearColor.g,this._clearColor.b,this._clearColor.a),e.enable(e.BLEND),e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),this._createShaderProgram(e),this._webGLErrorDetected)return void(this._webGLContext=null);this._createBuffers(e),this.updateViewport(this._viewportWidth||this.canvas.width||0,this._viewportHeight||this.canvas.height||0)}},e._setClearColor=function(t,e,r,i){this._clearColor.r=t,this._clearColor.g=e,this._clearColor.b=r,this._clearColor.a=i,this._webGLContext&&this._webGLContext.clearColor(t,e,r,i)},e._createShaderProgram=function(t){var e=this._createShader(t,t.FRAGMENT_SHADER,"precision mediump float;uniform sampler2D uSampler0;varying vec3 vTextureCoord;void main(void) {vec4 color = texture2D(uSampler0, vTextureCoord.st);gl_FragColor = vec4(color.rgb, color.a * vTextureCoord.z);}"),r=this._createShader(t,t.VERTEX_SHADER,"attribute vec2 aVertexPosition;attribute vec3 aTextureCoord;uniform mat3 uPMatrix;varying vec3 vTextureCoord;void main(void) {vTextureCoord = aTextureCoord;gl_Position = vec4((uPMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);}");if(!this._webGLErrorDetected&&e&&r){var i=t.createProgram();if(t.attachShader(i,e),t.attachShader(i,r),t.linkProgram(i),!t.getProgramParameter(i,t.LINK_STATUS))return void(this._webGLErrorDetected=!0);i.vertexPositionAttribute=t.getAttribLocation(i,"aVertexPosition"),i.textureCoordAttribute=t.getAttribLocation(i,"aTextureCoord"),i.sampler0uniform=t.getUniformLocation(i,"uSampler0"),t.enableVertexAttribArray(i.vertexPositionAttribute),t.enableVertexAttribArray(i.textureCoordAttribute),i.pMatrixUniform=t.getUniformLocation(i,"uPMatrix"),t.useProgram(i),this._shaderProgram=i}},e._createShader=function(t,e,r){var i=t.createShader(e);return t.shaderSource(i,r),t.compileShader(i),t.getShaderParameter(i,t.COMPILE_STATUS)?i:(this._webGLErrorDetected=!0,null)},e._createBuffers=function(e){this._verticesBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._verticesBuffer);var r=4*t.NUM_VERTEX_PROPERTIES;e.vertexAttribPointer(this._shaderProgram.vertexPositionAttribute,2,e.FLOAT,e.FALSE,r,0),e.vertexAttribPointer(this._shaderProgram.textureCoordAttribute,3,e.FLOAT,e.FALSE,r,8),this._indicesBuffer=e.createBuffer(),this._setMaxBoxesPoints(e,t.MAX_BOXES_POINTS_INCREMENT)},e._setMaxBoxesPoints=function(e,r){this._maxBoxesPointsPerDraw=r,this._maxBoxesPerDraw=this._maxBoxesPointsPerDraw/t.POINTS_PER_BOX|0,this._maxIndicesPerDraw=this._maxBoxesPerDraw*t.INDICES_PER_BOX,e.bindBuffer(e.ARRAY_BUFFER,this._verticesBuffer),this._vertices=new Float32Array(this._maxBoxesPerDraw*t.NUM_VERTEX_PROPERTIES_PER_BOX),e.bufferData(e.ARRAY_BUFFER,this._vertices,e.DYNAMIC_DRAW),this._indices=new Uint16Array(this._maxIndicesPerDraw);for(var i=0,a=this._indices.length;a>i;i+=t.INDICES_PER_BOX){var s=i*t.POINTS_PER_BOX/t.INDICES_PER_BOX;this._indices[i]=s,this._indices[i+1]=s+1,this._indices[i+2]=s+2,this._indices[i+3]=s,this._indices[i+4]=s+2,this._indices[i+5]=s+3}e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._indicesBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,this._indices,e.STATIC_DRAW)},e._setupImageTexture=function(t,e){if(e&&(e.naturalWidth||e.getContext||e.readyState>=2)){var r=e.__easeljs_texture;return r||(r=e.__easeljs_texture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,r),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE)),r}},e._drawWebGLKids=function(e,r,i){for(var a,s,n=this.snapToPixelEnabled,o=null,h=0,_=0,c=0,l=0,u=this._vertices,d=t.NUM_VERTEX_PROPERTIES_PER_BOX,x=t.MAX_INDEX_SIZE,E=this._maxBoxesPerDraw-1,p=0,f=e.length;f>p;p++)if(a=e[p],a.isVisible()){var o=a.image||a.spriteSheet&&a.spriteSheet._images[0],g=o.__easeljs_texture;if(g||(g=this._setupImageTexture(r,o))){s=a._props.matrix,s=(i?s.copy(i):s.identity()).appendTransform(a.x,a.y,a.scaleX,a.scaleY,a.rotation,a.skewX,a.skewY,a.regX,a.regY);var m=0,T=1,P=0,S=1;if(4===a._spritestage_compatibility)h=0,_=0,c=o.width,l=o.height;else if(2===a._spritestage_compatibility){var R=a.spriteSheet.getFrame(a.currentFrame),C=R.rect;h=-R.regX,_=-R.regY,c=h+C.width,l=_+C.height,m=C.x/o.width,P=C.y/o.height,T=m+C.width/o.width,S=P+C.height/o.height}else o=null,3===a._spritestage_compatibility&&a._updateText();if(!i&&a._spritestage_compatibility<=4&&g!==this._drawTexture&&(this._drawToGPU(r),this._drawTexture=g),null!==o){var v=++this._currentBoxIndex*d,w=s.a,b=s.b,A=s.c,B=s.d,L=s.tx,D=s.ty;n&&a.snapToPixel&&(L=L+(0>L?-.5:.5)|0,D=D+(0>D?-.5:.5)|0),u[v]=h*w+_*A+L,u[v+1]=h*b+_*B+D,u[v+5]=h*w+l*A+L,u[v+6]=h*b+l*B+D,u[v+10]=c*w+l*A+L,u[v+11]=c*b+l*B+D,u[v+15]=c*w+_*A+L,u[v+16]=c*b+_*B+D,u[v+2]=u[v+7]=m,u[v+12]=u[v+17]=T,u[v+3]=u[v+18]=P,u[v+8]=u[v+13]=S,u[v+4]=u[v+9]=u[v+14]=u[v+19]=a.alpha,this._currentBoxIndex===E&&(this._drawToGPU(r),this._drawTexture=g,this._maxBoxesPointsPerDraw<x&&(this._setMaxBoxesPoints(r,this._maxBoxesPointsPerDraw+t.MAX_BOXES_POINTS_INCREMENT),E=this._maxBoxesPerDraw-1))}a.children&&(this._drawWebGLKids(a.children,r,s),E=this._maxBoxesPerDraw-1)}}i||this._drawToGPU(r)},e._drawToGPU=function(e){if(this._drawTexture){var r=this._currentBoxIndex+1;e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this._drawTexture),e.uniform1i(this._shaderProgram.sampler0uniform,0),e.bindBuffer(e.ARRAY_BUFFER,this._verticesBuffer),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._indicesBuffer),e.uniformMatrix3fv(this._shaderProgram.pMatrixUniform,!1,this._projectionMatrix),e.bufferSubData(e.ARRAY_BUFFER,0,this._vertices),e.drawElements(e.TRIANGLES,r*t.INDICES_PER_BOX,e.UNSIGNED_SHORT,0),this._currentBoxIndex=-1,this._drawTexture=null}},createjs.SpriteStage=createjs.promote(t,"Stage")}();