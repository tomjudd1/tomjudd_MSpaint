function SimulationRenderer(e,t){function r(){var e=a(),t=o();f=n(THREE.RGBAFormat),v=f.clone(),T=n(THREE.RGBFormat),p=T.clone(),simulator.renderTexture(e,f),simulator.renderTexture(f,v),simulator.renderTexture(t,T),simulator.renderTexture(T,p),simulator.velocityUniforms.testing.value=10}function n(t){var r=new THREE.WebGLRenderTarget(e,e,{wrapS:THREE.RepeatWrapping,wrapT:THREE.RepeatWrapping,minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:t,type:THREE.FloatType,stencilBuffer:!1});return r}function a(){for(var t=new Float32Array(4*PARTICLES),r=0,n=t.length;n>r;r+=4){var a=Math.random()*BOUNDS-BOUNDS_HALF,o=Math.random()*BOUNDS-BOUNDS_HALF,i=Math.random()*BOUNDS-BOUNDS_HALF;t[r+0]=a,t[r+1]=o,t[r+2]=i,t[r+3]=1}var l=new THREE.DataTexture(t,e,e,THREE.RGBAFormat,THREE.FloatType);return l.minFilter=THREE.NearestFilter,l.magFilter=THREE.NearestFilter,l.needsUpdate=!0,l.flipY=!1,l}function o(){for(var t=new Float32Array(3*PARTICLES),r=0,n=t.length;n>r;r+=3){var a=Math.random()-.5,o=Math.random()-.5,i=Math.random()-.5;t[r+0]=10*a,t[r+1]=10*o,t[r+2]=10*i}var l=new THREE.DataTexture(t,e,e,THREE.RGBFormat,THREE.FloatType);return l.minFilter=THREE.NearestFilter,l.magFilter=THREE.NearestFilter,l.needsUpdate=!0,l.flipY=!1,l}e=e||4;var i=new THREE.Camera;if(i.position.z=1,gl=t.getContext(),!gl.getExtension("OES_texture_float"))return void alert("No OES_texture_float support for float textures!");if(0==gl.getParameter(gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS))return void alert("No support for vertex shader textures!");var l=new THREE.Scene,u={time:{type:"f",value:1},resolution:{type:"v2",value:new THREE.Vector2(e,e)},texture:{type:"t",value:null}},m=new THREE.ShaderMaterial({uniforms:u,vertexShader:document.getElementById("vertexShader").textContent,fragmentShader:document.getElementById("fragmentShader").textContent}),E=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),m),s=new THREE.ShaderMaterial({uniforms:{time:{type:"f",value:1},delta:{type:"f",value:0},resolution:{type:"v2",value:new THREE.Vector2(e,e)},texturePosition:{type:"t",value:null},textureVelocity:{type:"t",value:null}},vertexShader:document.getElementById("vertexShader").textContent,fragmentShader:document.getElementById("fragmentShaderPosition").textContent});this.positionShader=s;var d=new THREE.ShaderMaterial({uniforms:{time:{type:"f",value:1},delta:{type:"f",value:0},resolution:{type:"v2",value:new THREE.Vector2(e,e)},texturePosition:{type:"t",value:null},textureVelocity:{type:"t",value:null},testing:{type:"f",value:1},seperationDistance:{type:"f",value:1},alignmentDistance:{type:"f",value:1},cohesionDistance:{type:"f",value:1},freedomFactor:{type:"f",value:1},predator:{type:"v3",value:new THREE.Vector3}},defines:{WIDTH:e.toFixed(2)},vertexShader:document.getElementById("vertexShader").textContent,fragmentShader:document.getElementById("fragmentShaderVelocity").textContent});this.velocityUniforms=d.uniforms,l.add(E);var f,v,T,p,c=!0;this.init=r,this.renderTexture=function(e,r){E.material=m,u.texture.value=e,t.render(l,i,r)},this.renderPosition=function(e,r,n,a){E.material=s,s.uniforms.texturePosition.value=e,s.uniforms.textureVelocity.value=r,s.uniforms.time.value=performance.now(),s.uniforms.delta.value=a,t.render(l,i,n),this.currentPosition=n},this.renderVelocity=function(e,r,n,a){E.material=d,d.uniforms.texturePosition.value=e,d.uniforms.textureVelocity.value=r,d.uniforms.time.value=performance.now(),d.uniforms.delta.value=a,t.render(l,i,n),this.currentVelocity=n},this.simulate=function(e){c?(simulator.renderVelocity(f,T,p,e),simulator.renderPosition(f,p,v,e)):(simulator.renderVelocity(v,p,T,e),simulator.renderPosition(v,T,f,e)),c=!c}}