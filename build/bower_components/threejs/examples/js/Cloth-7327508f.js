function plane(t,i){return function(o,s){var e=(o-.5)*t,n=(s+.5)*i,r=0;return new THREE.Vector3(e,n,r)}}function Particle(t,i,o,s){this.position=clothFunction(t,i),this.previous=clothFunction(t,i),this.original=clothFunction(t,i),this.a=new THREE.Vector3(0,0,0),this.mass=s,this.invMass=1/s,this.tmp=new THREE.Vector3,this.tmp2=new THREE.Vector3}function satisifyConstrains(t,i,o){diff.subVectors(i.position,t.position);var s=diff.length();if(0!=s){var e=diff.multiplyScalar(1-o/s),n=e.multiplyScalar(.5);t.position.add(n),i.position.sub(n)}}function Cloth(t,i){function o(i,o){return i+o*(t+1)}t=t||10,i=i||10,this.w=t,this.h=i;var s,e,n=[],r=[];for(e=0;i>=e;e++)for(s=0;t>=s;s++)n.push(new Particle(s/t,e/i,0,MASS));for(e=0;i>e;e++)for(s=0;t>s;s++)r.push([n[o(s,e)],n[o(s,e+1)],restDistance]),r.push([n[o(s,e)],n[o(s+1,e)],restDistance]);for(s=t,e=0;i>e;e++)r.push([n[o(s,e)],n[o(s,e+1)],restDistance]);for(e=i,s=0;t>s;s++)r.push([n[o(s,e)],n[o(s+1,e)],restDistance]);this.particles=n,this.constrains=r,this.index=o}function simulate(t){if(!lastTime)return void(lastTime=t);var i,o,s,e,n,r;if(wind){var a,l,c=clothGeometry.faces;for(s=cloth.particles,i=0,o=c.length;o>i;i++)a=c[i],l=a.normal,tmpForce.copy(l).normalize().multiplyScalar(l.dot(windForce)),s[a.a].addForce(tmpForce),s[a.b].addForce(tmpForce),s[a.c].addForce(tmpForce)}for(s=cloth.particles,i=0,o=s.length;o>i;i++)e=s[i],e.addForce(gravity),e.integrate(TIMESTEP_SQ);for(n=cloth.constrains,o=n.length,i=0;o>i;i++)r=n[i],satisifyConstrains(r[0],r[1],r[2]);if(ballPosition.z=90*-Math.sin(Date.now()/600),ballPosition.x=70*Math.cos(Date.now()/400),sphere.visible)for(s=cloth.particles,i=0,o=s.length;o>i;i++)e=s[i],pos=e.position,diff.subVectors(pos,ballPosition),diff.length()<ballSize&&(diff.normalize().multiplyScalar(ballSize),pos.copy(ballPosition).add(diff));for(s=cloth.particles,i=0,o=s.length;o>i;i++)e=s[i],pos=e.position,pos.y<-250&&(pos.y=-250);for(i=0,o=pins.length;o>i;i++){var p=pins[i],h=s[p];h.position.copy(h.original),h.previous.copy(h.original)}}var DAMPING=.03,DRAG=1-DAMPING,MASS=.1,restDistance=25,xSegs=10,ySegs=10,clothFunction=plane(restDistance*xSegs,restDistance*ySegs),cloth=new Cloth(xSegs,ySegs),GRAVITY=981*1.4,gravity=new THREE.Vector3(0,-GRAVITY,0).multiplyScalar(MASS),TIMESTEP=.018,TIMESTEP_SQ=TIMESTEP*TIMESTEP,pins=[],wind=!0,windStrength=2,windForce=new THREE.Vector3(0,0,0),ballPosition=new THREE.Vector3(0,-45,0),ballSize=60,tmpForce=new THREE.Vector3,lastTime;Particle.prototype.addForce=function(t){this.a.add(this.tmp2.copy(t).multiplyScalar(this.invMass))},Particle.prototype.integrate=function(t){var i=this.tmp.subVectors(this.position,this.previous);i.multiplyScalar(DRAG).add(this.position),i.add(this.a.multiplyScalar(t)),this.tmp=this.previous,this.previous=this.position,this.position=i,this.a.set(0,0,0)};var diff=new THREE.Vector3;