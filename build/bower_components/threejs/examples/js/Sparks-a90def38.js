var SPARKS={};SPARKS.Emitter=function(t){this._counter=t?t:new SPARKS.SteadyCounter(10),this._particles=[],this._initializers=[],this._actions=[],this._activities=[],this._handlers=[],this.callbacks={}},SPARKS.Emitter.prototype={_TIMESTEP:15,_timer:null,_lastTime:null,_timerStep:10,_velocityVerlet:!0,start:function(){this._lastTime=Date.now(),this._timer=setTimeout(this.step,this._timerStep,this),this._isRunning=!0},stop:function(){this._isRunning=!1,clearTimeout(this._timer)},isRunning:function(){return this._isRunning&!0},step:function(t){var i=Date.now(),e=i-t._lastTime;if(this._velocityVerlet)t.update(e/1e3),t._lastTime=i;else{var o=20*t._TIMESTEP;for(e>=o&&(e=o);e>=t._TIMESTEP;)t.update(t._TIMESTEP/1e3),e-=t._TIMESTEP;t._lastTime=i-e}t._isRunning&&setTimeout(t.step,t._timerStep,t)},update:function(t){var i,e,o=this._counter.updateEmitter(this,t);for(i=0;o>i;i++)this.createParticle();for(o=this._activities.length,i=0;o>i;i++)this._activities[i].update(this,t);o=this._actions.length;var n,s,a=this._particles.length;for(e=0;o>e;e++)for(s=this._actions[e],i=0;a>i;++i)n=this._particles[i],s.update(this,n,t);for(i=a;i--;)n=this._particles[i],n.isDead?(this._particles.splice(i,1),this.dispatchEvent("dead",n),SPARKS.VectorPool.release(n.position),SPARKS.VectorPool.release(n.velocity)):this.dispatchEvent("updated",n);this.dispatchEvent("loopUpdated")},createParticle:function(){var t,i=new SPARKS.Particle,e=this._initializers.length;for(t=0;e>t;t++)this._initializers[t].initialize(this,i);return this._particles.push(i),this.dispatchEvent("created",i),i},addInitializer:function(t){this._initializers.push(t)},addAction:function(t){this._actions.push(t)},removeInitializer:function(t){var i=this._initializers.indexOf(t);i>-1&&this._initializers.splice(i,1)},removeAction:function(t){var i=this._actions.indexOf(t);i>-1&&this._actions.splice(i,1)},addCallback:function(t,i){this.callbacks[t]=i},dispatchEvent:function(t,i){var e=this.callbacks[t];e&&e(i)}},SPARKS.EVENT_PARTICLE_CREATED="created",SPARKS.EVENT_PARTICLE_UPDATED="updated",SPARKS.EVENT_PARTICLE_DEAD="dead",SPARKS.EVENT_LOOP_UPDATED="loopUpdated",SPARKS.SteadyCounter=function(t){this.rate=t,this.leftover=0},SPARKS.SteadyCounter.prototype.updateEmitter=function(t,i){var e=i*this.rate+this.leftover,o=Math.floor(e);return this.leftover=e-o,o},SPARKS.ShotCounter=function(t){this.particles=t,this.used=!1},SPARKS.ShotCounter.prototype.updateEmitter=function(){return this.used?0:(this.used=!0,this.particles)},SPARKS.Particle=function(){this.lifetime=0,this.age=0,this.energy=1,this.isDead=!1,this.target=null,this.position=SPARKS.VectorPool.get().set(0,0,0),this.velocity=SPARKS.VectorPool.get().set(0,0,0),this._oldvelocity=SPARKS.VectorPool.get().set(0,0,0)},SPARKS.Action=function(){this._priority=0},SPARKS.Age=function(t){this._easing=null==t?TWEEN.Easing.Linear.None:t},SPARKS.Age.prototype.update=function(t,i,e){if(i.age+=e,i.age>=i.lifetime)i.energy=0,i.isDead=!0;else{var o=this._easing(i.age/i.lifetime);i.energy=-1*o+1}},SPARKS.Move=function(){},SPARKS.Move.prototype.update=function(t,i,e){var o=i.position,n=i.velocity,s=i._oldvelocity;this._velocityVerlet?(o.x+=.5*(n.x+s.x)*e,o.y+=.5*(n.y+s.y)*e,o.z+=.5*(n.z+s.z)*e):(o.x+=n.x*e,o.y+=n.y*e,o.z+=n.z*e)},SPARKS.DeathZone=function(t){this.zone=t},SPARKS.DeathZone.prototype.update=function(t,i){this.zone.contains(i.position)&&(i.isDead=!0)},SPARKS.ActionZone=function(t,i){this.action=t,this.zone=i},SPARKS.ActionZone.prototype.update=function(t,i,e){this.zone.contains(i.position)&&this.action.update(t,i,e)},SPARKS.Accelerate=function(t,i,e){return t instanceof THREE.Vector3?void(this.acceleration=t):void(this.acceleration=new THREE.Vector3(t,i,e))},SPARKS.Accelerate.prototype.update=function(t,i,e){var o=this.acceleration,n=i.velocity;i._oldvelocity.set(n.x,n.y,n.z),n.x+=o.x*e,n.y+=o.y*e,n.z+=o.z*e},SPARKS.AccelerateFactor=function(t){this.factor=t},SPARKS.AccelerateFactor.prototype.update=function(t,i,e){var o,n=this.factor,s=i.velocity,a=s.length();a>0&&(o=n*e/a,o+=1,s.multiplyScalar(o))},SPARKS.AccelerateVelocity=function(t){this.factor=t},SPARKS.AccelerateVelocity.prototype.update=function(t,i){var e=this.factor,o=i.velocity;o.z+=-o.x*e,o.y+=o.z*e,o.x+=o.y*e},SPARKS.RandomDrift=function(t,i,e){return t instanceof THREE.Vector3?void(this.drift=t):void(this.drift=new THREE.Vector3(t,i,e))},SPARKS.RandomDrift.prototype.update=function(t,i,e){var o=this.drift,n=i.velocity;n.x+=(Math.random()-.5)*o.x*e,n.y+=(Math.random()-.5)*o.y*e,n.z+=(Math.random()-.5)*o.z*e},SPARKS.Zone=function(){},SPARKS.PointZone=function(t){this.pos=t},SPARKS.PointZone.prototype.getLocation=function(){return this.pos},SPARKS.PointZone=function(t){this.pos=t},SPARKS.PointZone.prototype.getLocation=function(){return this.pos},SPARKS.LineZone=function(t,i){this.start=t,this.end=i,this._length=i.clone().sub(t)},SPARKS.LineZone.prototype.getLocation=function(){var t=this._length.clone();return t.multiplyScalar(Math.random()),t.add(this.start)},SPARKS.ParallelogramZone=function(t,i,e){this.corner=t,this.side1=i,this.side2=e},SPARKS.ParallelogramZone.prototype.getLocation=function(){var t=this.side1.clone().multiplyScalar(Math.random()),i=this.side2.clone().multiplyScalar(Math.random());return t.add(i),t.add(this.corner)},SPARKS.CubeZone=function(t,i,e,o){this.position=t,this.x=i,this.y=e,this.z=o},SPARKS.CubeZone.prototype.getLocation=function(){var t=this.position.clone();return t.x+=Math.random()*this.x,t.y+=Math.random()*this.y,t.z+=Math.random()*this.z,t},SPARKS.CubeZone.prototype.contains=function(t){var i=this.position.x,e=this.position.y,o=this.position.z,n=this.x,s=this.y,a=this.z;0>n&&(i+=n,n=Math.abs(n)),0>s&&(e+=s,s=Math.abs(s)),0>a&&(o+=a,a=Math.abs(a));var r=t.x-i,c=t.y-e,h=t.z-o;return r>0&&n>r&&c>0&&s>c&&h>0&&a>h?!0:!1},SPARKS.SphereCapZone=function(t,i,e,o,n,s){this.x=t,this.y=i,this.z=e,this.minr=o,this.maxr=n,this.angle=s},SPARKS.SphereCapZone.prototype.getLocation=function(){var t=2*Math.PI*SPARKS.Utils.random(),i=SPARKS.Utils.random(),e=SPARKS.VectorPool.get().set(i*Math.cos(t),-1/Math.tan(this.angle*SPARKS.Utils.DEGREE_TO_RADIAN),i*Math.sin(t)),o=this.minr-(this.minr-this.maxr)*Math.random();return e.multiplyScalar(o),e.__markedForReleased=!0,e},SPARKS.Lifetime=function(t,i){this._min=t,this._max=i?i:t},SPARKS.Lifetime.prototype.initialize=function(t,i){i.lifetime=this._min+SPARKS.Utils.random()*(this._max-this._min)},SPARKS.Position=function(t){this.zone=t},SPARKS.Position.prototype.initialize=function(t,i){var e=this.zone.getLocation();i.position.set(e.x,e.y,e.z)},SPARKS.Velocity=function(t){this.zone=t},SPARKS.Velocity.prototype.initialize=function(t,i){var e=this.zone.getLocation();i.velocity.set(e.x,e.y,e.z),e.__markedForReleased&&(SPARKS.VectorPool.release(e),e.__markedForReleased=!1)},SPARKS.Target=function(t,i){this.target=t,this.callback=i},SPARKS.Target.prototype.initialize=function(t,i){i.target=this.callback?this.callback():this.target},SPARKS.VectorPool={__pools:[],get:function(){return this.__pools.length>0?this.__pools.pop():this._addToPool()},release:function(t){this.__pools.push(t)},_addToPool:function(){for(var t=0,i=100;i>t;t++)this.__pools.push(new THREE.Vector3);return new THREE.Vector3}},SPARKS.Utils={random:function(){return Math.random()},DEGREE_TO_RADIAN:Math.PI/180,TWOPI:2*Math.PI,getPerpendiculars:function(t){var i=this.getPerpendicular(t),e=t.cross(i);return e.normalize(),[i,e]},getPerpendicular:function(t){if(0==t.x)return new THREE.Vector3D(1,0,0);var i=new THREE.Vector3(t.y,-t.x,0);return i.normalize()}};