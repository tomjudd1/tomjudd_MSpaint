THREE.SoftwareRenderer=function(e){function t(){for(var e=c*v*4,t=0;e>t;t+=4)y[t]=255*I.r|0,y[t+1]=255*I.g|0,y[t+2]=255*I.b|0,y[t+3]=255;S.fillStyle=I.getStyle(),S.fillRect(0,0,c,v)}function a(e,t){var a=0,r=0,o=255*e.color.r,i=255*e.color.g,f=255*e.color.b,n=new Uint8Array(768);if(t){for(;204>a;)n[r++]=Math.min(a*o/204,255),n[r++]=Math.min(a*i/204,255),n[r++]=Math.min(a*f/204,255),++a;for(;256>a;)n[r++]=Math.min(o+(a-204)*(255-o)/82,255),n[r++]=Math.min(i+(a-204)*(255-i)/82,255),n[r++]=Math.min(f+(a-204)*(255-f)/82,255),++a}else for(;256>a;)n[r++]=Math.min(a*o/255,255),n[r++]=Math.min(a*i/255,255),n[r++]=Math.min(a*f/255,255),++a;return n}function r(e,t,a,r,o,i,f,n,l){var s=4*a,c=z[l.map.id];if(c.data){var v=c.width,h=l.transparent,u=v-1,m=c.data,p=4*((i*v&u)*v+(o*v&u));if(h){var d=m[p+3]*l.opacity,E=(m[p]<<16)+(m[p+1]<<8)+m[p+2];if(250>d){var M=(e[s]<<16)+(e[s+1]<<8)+e[s+2];E=E*d+M*(1-d)}e[s]=(16711680&E)>>16,e[s+1]=(65280&E)>>8,e[s+2]=255&E,e[s+3]=255*l.opacity}else e[s]=m[p],e[s+1]=m[p+1],e[s+2]=m[p+2],e[s+3]=255*l.opacity,t[a]=r}}function o(e,t,a,r,o,i,f,n,l){var s=4*a,c=z[l.map.id];if(c.data){var v=c.width,h=l.transparent,u=3*(f>0?~~f:0),m=v-1,p=c.data,d=4*((i*v&m)*v+(o*v&m));if(h){var E=p[d+3]*l.opacity,M=(l.palette[u]*p[d]<<16)+(l.palette[u+1]*p[d+1]<<8)+l.palette[u+2]*p[d+2];if(250>E){var g=e[s]<<24+e[s+1]<<16+e[s+2]<<8;M=M*E+g*(1-E)}e[s]=(16711680&M)>>16,e[s+1]=(65280&M)>>8,e[s+2]=255&M,e[s+3]=255*l.opacity}else e[s]=l.palette[u]*p[d]>>8,e[s+1]=l.palette[u+1]*p[d+1]>>8,e[s+2]=l.palette[u+2]*p[d+2]>>8,e[s+3]=255*l.opacity,t[a]=r}}function i(e){var t=e.target;t.removeEventListener("update",i),delete O[t.id]}function f(e){var t=e.id,f=O[t];if(void 0===O[t]){if(e.addEventListener("update",i),e instanceof THREE.MeshBasicMaterial||e instanceof THREE.MeshLambertMaterial||e instanceof THREE.MeshPhongMaterial||e instanceof THREE.SpriteMaterial){e instanceof THREE.MeshLambertMaterial?e.palette||(e.palette=a(e,!1)):e instanceof THREE.MeshPhongMaterial&&(e.palette||(e.palette=a(e,!0)));var n;if(e.map){var l=new THREE.SoftwareRenderer.Texture;l.fromImage(e.map.image),e.map.addEventListener("update",function(e){l.fromImage(e.target.image)}),z[e.map.id]=l,f=e instanceof THREE.MeshBasicMaterial||e instanceof THREE.SpriteMaterial?r:o}else n=e.vertexColors===THREE.FaceColors?["var colorOffset = offset * 4;","buffer[ colorOffset ] = face.color.r * 255;","buffer[ colorOffset + 1 ] = face.color.g * 255;","buffer[ colorOffset + 2 ] = face.color.b * 255;","buffer[ colorOffset + 3 ] = material.opacity * 255;","depthBuf[ offset ] = depth;"].join("\n"):["var colorOffset = offset * 4;","buffer[ colorOffset ] = material.color.r * 255;","buffer[ colorOffset + 1 ] = material.color.g * 255;","buffer[ colorOffset + 2 ] = material.color.b * 255;","buffer[ colorOffset + 3 ] = material.opacity * 255;","depthBuf[ offset ] = depth;"].join("\n"),f=new Function("buffer, depthBuf, offset, depth, u, v, n, face, material",n)}else{var n=["var colorOffset = offset * 4;","buffer[ colorOffset ] = u * 255;","buffer[ colorOffset + 1 ] = v * 255;","buffer[ colorOffset + 2 ] = 0;","buffer[ colorOffset + 3 ] = 255;","depthBuf[ offset ] = depth;"].join("\n");f=new Function("buffer, depthBuf, offset, depth, u, v",n)}O[t]=f}return f}function n(e,t,a,r,o,i,f,n,s){if(!(e.z<-1||e.z>1||t.z<-1||t.z>1||a.z<-1||a.z>1)){var u,R,w,H,S,O,z=e.x*m+E|0,I=t.x*m+E|0,N=a.x*m+E|0,U=e.y*p+M|0,q=t.y*p+M|0,G=a.y*p+M|0,J=e.z*d+g|0,K=t.z*d+g|0,Q=a.z*d+g|0,W=!1;r&&o&&i&&(W=!0,u=r.x,R=1-r.y,w=o.x,H=1-o.y,S=i.x,O=1-i.y);var X,Y,Z,$,_,et,tt=!1;n.vertexNormalsModel&&(tt=!0,X=n.vertexNormalsModel[0],Y=n.vertexNormalsModel[1],Z=n.vertexNormalsModel[2],$=255*X.z,_=255*Y.z,et=255*Z.z);var at=z-I,rt=q-U,ot=I-N,it=G-q,ft=N-z,nt=U-G,lt=Math.max(Math.min(z,I,N)+j>>B,0),st=Math.min(Math.max(z,I,N)+j>>B,c),ct=Math.max(Math.min(U,q,G)+j>>B,0),vt=Math.min(Math.max(U,q,G)+j>>B,v);P=Math.min(lt,P),A=Math.max(st,A),k=Math.min(ct,k),D=Math.max(vt,D);var ht=L;lt&=~(ht-1),ct&=~(ht-1);var ut=lt<<B,mt=ct<<B,pt=rt*(ut-z)+at*(mt-U),dt=it*(ut-I)+ot*(mt-q),Et=nt*(ut-N)+ft*(mt-G);(rt>0||0==rt&&at>0)&&pt++,(it>0||0==it&&ot>0)&&dt++,(nt>0||0==nt&&ft>0)&&Et++,pt=pt-1>>B,dt=dt-1>>B,Et=Et-1>>B;var Mt=J-K,gt=Q-J,Rt=1/(at*nt-ft*rt),yt=Rt*(Mt*nt-gt*rt),xt=Rt*(Mt*ft-at*gt),wt=J+(ut-z)*yt+(mt-U)*xt|0,Tt=1<<B;yt=yt*Tt|0,xt=xt*Tt|0;var bt,Ht,St,Ot;if(W){var zt=u-w,It=S-u,Ct=Rt*(zt*nt-It*rt),Vt=Rt*(zt*ft-at*It),Bt=R-H,jt=O-R;bt=Rt*(Bt*nt-jt*rt),Ht=Rt*(Bt*ft-at*jt),St=u+(ut-z)*Ct+(mt-U)*Vt,Ot=R+(ut-z)*bt+(mt-U)*Ht,Ct*=Tt,Vt*=Tt,bt*=Tt,Ht*=Tt}var Ft,Lt;if(tt){var Nt=$-_,Pt=et-$,kt=Rt*(Nt*nt-Pt*rt),Ft=Rt*(Nt*ft-at*Pt);Lt=$+(ut-z)*kt+(mt-U)*Ft,kt*=Tt,Ft*=Tt}var At=ht-1,Dt=0,Ut=0,qt=0,Gt=0,Jt=0,Kt=0,Qt=0,Wt=0;at>=0?Ut-=At*at:Dt-=At*at,rt>=0?Ut-=At*rt:Dt-=At*rt,ot>=0?Gt-=At*ot:qt-=At*ot,it>=0?Gt-=At*it:qt-=At*it,ft>=0?Kt-=At*ft:Jt-=At*ft,nt>=0?Kt-=At*nt:Jt-=At*nt,yt>=0?Wt+=At*yt:Qt+=At*yt,xt>=0?Wt+=At*xt:Qt+=At*xt;var Xt,Yt,Zt=c-ht,$t=pt,_t=dt,ea=Et,ta=wt,aa=-ht,ra=aa*rt,oa=aa*it,ia=aa*nt,fa=aa*yt;W&&(Xt=aa*Ct,Yt=aa*bt);var na;tt&&(na=aa*kt);for(var la=lt,sa=ct;vt>sa;sa+=ht){for(;la>=lt&&st>la&&$t>=Ut&&_t>=Gt&&ea>=Kt;)la+=aa,$t+=ra,_t+=oa,ea+=ia,ta+=fa,W&&(St+=Xt,Ot+=Yt),tt&&(Lt+=na);for(aa=-aa,ra=-ra,oa=-oa,ia=-ia,fa=-fa,W&&(Xt=-Xt,Yt=-Yt),tt&&(na=-na);;){if(la+=aa,$t+=ra,_t+=oa,ea+=ia,ta+=fa,W&&(St+=Xt,Ot+=Yt),tt&&(Lt+=na),lt>la||la>=st)break;if(Ut>$t){if(0>ra)break}else if(Gt>_t){if(0>oa)break}else if(Kt>ea){if(0>ia)break}else{var ca=la>>F,va=sa>>F,ha=ca+va*h,ua=ta+Qt;if(!(T[ha]<ua)){var ma=b[ha];ma&V&&l(ca,va),b[ha]=ma&~(C|V);var pa=la+sa*c;if($t>=Dt&&_t>=qt&&ea>=Jt){var da=ta+Wt;T[ha]=Math.min(T[ha],da);var Ea,Ma,ga=$t,Ra=_t,ya=ta;W&&(Ea=St,Ma=Ot);var xa;tt&&(xa=Lt);for(var wa=0;ht>wa;wa++){var Ta,ba,Ha=ga,Sa=Ra,Oa=ya;W&&(Ta=Ea,ba=Ma);var za;tt&&(za=xa);for(var Ia=0;ht>Ia;Ia++){var Ca=Oa;Ca<x[pa]&&f(y,x,pa,Ca,Ta,ba,za,n,s),Ha+=rt,Sa+=it,Oa+=yt,W&&(Ta+=Ct,ba+=bt),tt&&(za+=kt),pa++}ga+=at,Ra+=ot,ya+=xt,W&&(Ea+=Vt,Ma+=Ht),tt&&(xa+=Ft),pa+=Zt}}else{var Ea,Ma,ga=$t,Ra=_t,Va=ea,ya=ta;W&&(Ea=St,Ma=Ot);var xa;tt&&(xa=Lt);for(var wa=0;ht>wa;wa++){var Ta,ba,Ha=ga,Sa=Ra,Ba=Va,Oa=ya;W&&(Ta=Ea,ba=Ma);var za;tt&&(za=xa);for(var Ia=0;ht>Ia;Ia++){if((Ha|Sa|Ba)>=0){var Ca=Oa;Ca<x[pa]&&f(y,x,pa,Ca,Ta,ba,za,n,s)}Ha+=rt,Sa+=it,Ba+=nt,Oa+=yt,W&&(Ta+=Ct,ba+=bt),tt&&(za+=kt),pa++}ga+=at,Ra+=ot,Va+=ft,ya+=xt,W&&(Ea+=Vt,Ma+=Ht),tt&&(xa+=Ft),pa+=Zt}}}}}$t+=ht*at,_t+=ht*ot,ea+=ht*ft,ta+=ht*xt,W&&(St+=ht*Vt,Ot+=ht*Ht),tt&&(Lt+=ht*Ft)}}}function l(e,t){for(var a=e*L+t*L*c,r=4*a,o=c-L,i=4*o,f=0;L>f;f++){for(var n=0;L>n;n++)x[a++]=N,y[r++]=255*I.r|0,y[r++]=255*I.g|0,y[r++]=255*I.b|0,y[r++]=255;a+=o,r+=i}}function s(){for(var e=0,t=0;u>t;t++)for(var a=0;h>a;a++)b[e]&V&&(l(a,t),b[e]=C),e++}console.log("THREE.SoftwareRenderer",THREE.REVISION),e=e||{};var c,v,h,u,m,p,d,E,M,g,R,y,x,w,T,b,H=void 0!==e.canvas?e.canvas:document.createElement("canvas"),S=H.getContext("2d",{alpha:e.alpha===!0}),O={},z={},I=new THREE.Color(0),C=1,V=2,B=4,j=(1<<B)-1,F=3,L=1<<F,N=1<<24,P=1/0,k=1/0,A=0,D=0,U=1/0,q=1/0,G=0,J=0,K=new THREE.Projector,Q=new THREE.Vector3,W=new THREE.Vector3,X=new THREE.Vector3,Y=new THREE.Vector2,Z=new THREE.Vector2,$=new THREE.Vector2;this.domElement=H,this.autoClear=!0,this.supportsVertexTextures=function(){},this.setFaceCulling=function(){},this.setClearColor=function(e){I.set(e),t()},this.setPixelRatio=function(){},this.setSize=function(e,a){h=Math.floor(e/L),u=Math.floor(a/L),c=h*L,v=u*L;var r=1<<B;m=r*c/2,p=-r*v/2,d=N/2,E=r*c/2+.5,M=r*v/2+.5,g=N/2+.5,H.width=c,H.height=v,S.fillStyle=I.getStyle(),S.fillRect(0,0,c,v),R=S.getImageData(0,0,c,v),y=R.data,x=new Int32Array(y.length/4),w=h*u,T=new Int32Array(w),b=new Uint8Array(w);for(var o=0,i=x.length;i>o;o++)x[o]=N;for(var o=0;w>o;o++)b[o]=C;t()},this.setSize(H.width,H.height),this.clear=function(){P=1/0,k=1/0,A=0,D=0;for(var e=0;w>e;e++)T[e]=N,b[e]=b[e]&C?C:V},this.render=function(e,t){this.autoClear===!0&&this.clear();for(var a=K.projectScene(e,t,!1,!1),r=a.elements,o=0,i=r.length;i>o;o++){var l=r[o],c=l.material,v=f(c);if(l instanceof THREE.RenderableFace)l.uvs?n(l.v1.positionScreen,l.v2.positionScreen,l.v3.positionScreen,l.uvs[0],l.uvs[1],l.uvs[2],v,l,c):n(l.v1.positionScreen,l.v2.positionScreen,l.v3.positionScreen,null,null,null,v,l,c);else if(l instanceof THREE.RenderableSprite){var h=.5*l.scale.x,u=.5*l.scale.y;Q.copy(l),Q.x-=h,Q.y+=u,W.copy(l),W.x-=h,W.y-=u,X.copy(l),X.x+=h,X.y+=u,c.map?(Y.set(0,1),Z.set(0,0),$.set(1,1),n(Q,W,X,Y,Z,$,v,l,c)):n(Q,W,X,null,null,null,v,l,c),Q.copy(l),Q.x+=h,Q.y+=u,W.copy(l),W.x-=h,W.y-=u,X.copy(l),X.x+=h,X.y-=u,c.map?(Y.set(1,1),Z.set(0,0),$.set(1,0),n(Q,W,X,Y,Z,$,v,l,c)):n(Q,W,X,null,null,null,v,l,c)}}s();var m=Math.min(P,U),p=Math.min(k,q),d=Math.max(A,G)-m,E=Math.max(D,J)-p;1/0!==m&&S.putImageData(R,0,0,m,p,d,E),U=P,q=k,G=A,J=D}},THREE.SoftwareRenderer.Texture=function(){var e;this.fromImage=function(t){if(!(!t||t.width<=0||t.height<=0)){void 0===e&&(e=document.createElement("canvas"));var a=t.width>t.height?t.width:t.height;a=THREE.Math.nextPowerOfTwo(a),(e.width!=a||e.height!=a)&&(e.width=a,e.height=a);var r=e.getContext("2d");r.clearRect(0,0,a,a),r.drawImage(t,0,0,a,a);var o=r.getImageData(0,0,a,a);this.data=o.data,this.width=a,this.height=a,this.srcUrl=t.src}}};