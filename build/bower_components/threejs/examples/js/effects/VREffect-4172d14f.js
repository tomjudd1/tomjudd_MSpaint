THREE.VREffect=function(e,t){var r=new THREE.PerspectiveCamera,n=new THREE.PerspectiveCamera;this._renderer=e,this._init=function(){function e(e){for(var n,i,a=0;a<e.length;++a)if(e[a]instanceof HMDVRDevice){n=e[a],r._vrHMD=n,r.leftEyeTranslation=n.getEyeTranslation("left"),r.rightEyeTranslation=n.getEyeTranslation("right"),r.leftEyeFOV=n.getRecommendedEyeFieldOfView("left"),r.rightEyeFOV=n.getRecommendedEyeFieldOfView("right");break}t&&(n||(i="HMD not available"),t(i))}var r=this;return navigator.mozGetVRDevices||navigator.getVRDevices?void(navigator.getVRDevices?navigator.getVRDevices().then(e):navigator.mozGetVRDevices(e)):void(t&&t("Your browser is not VR Ready"))},this._init(),this.render=function(e){var t=this._renderer,r=this._vrHMD;return r?void this.renderStereo.apply(this,arguments):(e instanceof Array&&(e=e[0]),void t.render.apply(this._renderer,arguments))},this.renderStereo=function(e,t){var i,a;e instanceof Array?(i=e[0],a=e[1]):(i=e,a=e);var s=this.leftEyeTranslation,o=this.rightEyeTranslation,l=this._renderer,c=l.context.drawingBufferWidth,h=l.context.drawingBufferHeight,f=c/2;l.enableScissorTest(!0),l.clear(),void 0===t.parent&&t.updateMatrixWorld(),r.projectionMatrix=this.FovToProjection(this.leftEyeFOV,!0,t.near,t.far),n.projectionMatrix=this.FovToProjection(this.rightEyeFOV,!0,t.near,t.far),t.matrixWorld.decompose(r.position,r.quaternion,r.scale),t.matrixWorld.decompose(n.position,n.quaternion,n.scale),r.translateX(s.x),n.translateX(o.x),l.setViewport(0,0,f,h),l.setScissor(0,0,f,h),l.render(i,r),l.setViewport(f,0,f,h),l.setScissor(f,0,f,h),l.render(a,n),l.enableScissorTest(!1)},this.setSize=function(t,r){e.setSize(t,r)},this.setFullScreen=function(e){var t=this._renderer,r=this._vrHMD,n=this._canvasOriginalSize;if(r&&e!==this._fullScreen){if(this._fullScreen=!!e,!e)return void t.setSize(n.width,n.height);this._canvasOriginalSize={width:t.domElement.width,height:t.domElement.height},t.setSize(1280,800,!1),this.startFullscreen()}},this.startFullscreen=function(){function e(){document.mozFullScreenElement||document.webkitFullscreenElement||t.setFullScreen(!1)}var t=this,r=this._renderer,n=this._vrHMD,i=r.domElement,a=i.mozRequestFullScreen?"mozfullscreenchange":"webkitfullscreenchange";document.addEventListener(a,e,!1),i.mozRequestFullScreen?i.mozRequestFullScreen({vrDisplay:n}):i.webkitRequestFullscreen&&i.webkitRequestFullscreen({vrDisplay:n})},this.FovToNDCScaleOffset=function(e){var t=2/(e.leftTan+e.rightTan),r=(e.leftTan-e.rightTan)*t*.5,n=2/(e.upTan+e.downTan),i=(e.upTan-e.downTan)*n*.5;return{scale:[t,n],offset:[r,i]}},this.FovPortToProjection=function(e,t,r,n){t=void 0===t?!0:t,r=void 0===r?.01:r,n=void 0===n?1e4:n;var i=t?-1:1,a=new THREE.Matrix4,s=a.elements,o=this.FovToNDCScaleOffset(e);return s[0]=o.scale[0],s[1]=0,s[2]=o.offset[0]*i,s[3]=0,s[4]=0,s[5]=o.scale[1],s[6]=-o.offset[1]*i,s[7]=0,s[8]=0,s[9]=0,s[10]=n/(r-n)*-i,s[11]=n*r/(r-n),s[12]=0,s[13]=0,s[14]=i,s[15]=0,a.transpose(),a},this.FovToProjection=function(e,t,r,n){var i={upTan:Math.tan(e.upDegrees*Math.PI/180),downTan:Math.tan(e.downDegrees*Math.PI/180),leftTan:Math.tan(e.leftDegrees*Math.PI/180),rightTan:Math.tan(e.rightDegrees*Math.PI/180)};return this.FovPortToProjection(i,t,r,n)}};